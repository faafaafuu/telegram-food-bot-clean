<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>Jafood - –î–æ—Å—Ç–∞–≤–∫–∞ –µ–¥—ã</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, sans-serif; background: #f5f5f5; }
        .header { background: #fff; padding: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; text-align: center; }
        .header h1 { font-size: 28px; color: #ff6900; font-weight: 700; }
        .tabs { display: flex; gap: 12px; padding: 16px; overflow-x: auto; background: #fff; white-space: nowrap; }
        .tabs::-webkit-scrollbar { height: 6px; }
        .tabs::-webkit-scrollbar-thumb { background: #ddd; border-radius: 3px; }
        .tab { padding: 10px 20px; border-radius: 20px; background: #f0f0f0; cursor: pointer; font-size: 15px; font-weight: 500; border: none; transition: all 0.2s; }
        .tab.active { background: #ff6900; color: #fff; font-weight: 600; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 16px; padding: 16px; }
        .card { background: #fff; border-radius: 16px; overflow: hidden; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: transform 0.2s, box-shadow 0.2s; }
        .card:hover { transform: translateY(-4px); box-shadow: 0 4px 16px rgba(0,0,0,0.12); }
        .card img { width: 100%; height: 170px; object-fit: cover; }
        .card-body { padding: 14px; }
        .card-title { font-size: 15px; font-weight: 600; margin-bottom: 6px; color: #222; }
        .card-price { font-size: 18px; font-weight: 700; color: #ff6900; margin: 10px 0; }
        .card-desc { font-size: 13px; color: #666; margin: 6px 0; line-height: 1.4; }
        .btn-add { background: #ff6900; color: #fff; border: none; padding: 10px 16px; border-radius: 10px; cursor: pointer; margin-top: 10px; width: 100%; font-size: 14px; font-weight: 600; transition: background 0.2s; }
        .btn-add:hover { background: #e55e00; }
        .cart-btn { position: fixed; bottom: 20px; right: 20px; background: #ff6900; color: #fff; padding: 14px 28px; border-radius: 28px; cursor: pointer; box-shadow: 0 4px 20px rgba(255,105,0,0.4); z-index: 200; border: none; font-size: 17px; font-weight: 600; transition: all 0.2s; }
        .cart-btn:hover { background: #e55e00; transform: scale(1.05); }
        .cart-count { background: #fff; color: #ff6900; border-radius: 50%; padding: 3px 10px; margin-left: 10px; font-weight: 700; font-size: 15px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 300; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: #fff; border-radius: 16px; max-width: 500px; width: 92%; max-height: 85%; overflow-y: auto; padding: 26px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { font-size: 24px; font-weight: 700; color: #222; }
        .close { font-size: 32px; cursor: pointer; color: #666; line-height: 1; transition: color 0.2s; }
        .close:hover { color: #ff6900; }
        .cart-item { display: flex; justify-content: space-between; padding: 14px 0; border-bottom: 1px solid #eee; font-size: 15px; }
        .cart-item:last-child { border-bottom: none; }
        .cart-total { font-size: 22px; font-weight: 700; margin-top: 20px; text-align: right; color: #ff6900; }
        .btn-checkout { background: #ff6900; color: #fff; border: none; padding: 14px; border-radius: 12px; cursor: pointer; width: 100%; margin-top: 20px; font-size: 17px; font-weight: 600; transition: background 0.2s; }
        .btn-checkout:hover { background: #e55e00; }
        .empty-cart { text-align: center; color: #999; padding: 40px 20px; font-size: 16px; }
        .loading { text-align: center; padding: 60px 20px; color: #666; font-size: 16px; }
        @media (max-width: 520px) { 
            .grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; padding: 12px; }
            .card img { height: 140px; }
        }
    </style>
</head>
<body>
    <div class="header"><h1>üçï Jafood</h1></div>
    <div class="tabs" id="tabs"></div>
    <div class="grid" id="content"><div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–Ω—é...</div></div>
    <button class="cart-btn" onclick="openCart()">–ö–æ—Ä–∑–∏–Ω–∞ <span class="cart-count" id="cartCount">0</span></button>
    <div class="modal" id="cartModal" onclick="closeCartOnOutside(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>–ö–æ—Ä–∑–∏–Ω–∞</h2>
                <span class="close" onclick="closeCart()">&times;</span>
            </div>
            <div id="cartItems"></div>
            <div class="cart-total">–ò—Ç–æ–≥–æ: <span id="cartTotal">0</span> ‚ÇΩ</div>
            <button class="btn-checkout" onclick="checkout()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
        </div>
    </div>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        let categories = [];
        let products = [];
        let cart = [];
        let activeCategory = null;
        const API_BASE = window.location.origin;

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ë–î
        async function loadData() {
            try {
                const [categoriesRes, productsRes] = await Promise.all([
                    fetch(API_BASE + '/api/categories'),
                    fetch(API_BASE + '/api/products')
                ]);
                
                if (!categoriesRes.ok || !productsRes.ok) {
                    throw new Error('Failed to load data');
                }
                
                categories = await categoriesRes.json();
                products = await productsRes.json();
                
                if (categories.length > 0) {
                    activeCategory = categories[0].id;
                }
                
                renderTabs();
                renderProducts();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('content').innerHTML = '<div class="empty-cart">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.<br>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.</div>';
            }
        }

        function renderTabs() {
            const tabs = document.getElementById('tabs');
            tabs.innerHTML = categories.map(c => 
                '<button class="tab ' + (c.id === activeCategory ? 'active' : '') + '" onclick="selectCategory(' + c.id + ')">' + c.title + '</button>'
            ).join('');
        }

        function renderProducts() {
            const content = document.getElementById('content');
            const filtered = products.filter(p => p.category_id === activeCategory);
            
            if (filtered.length === 0) {
                content.innerHTML = '<div class="empty-cart">–¢–æ–≤–∞—Ä—ã –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</div>';
                return;
            }
            
            content.innerHTML = filtered.map(p => 
                '<div class="card">' +
                    '<img src="' + (p.image_url || 'https://via.placeholder.com/300x200?text=No+Image') + '" alt="' + p.name + '" loading="lazy">' +
                    '<div class="card-body">' +
                        '<div class="card-title">' + p.name + '</div>' +
                        (p.description ? '<div class="card-desc">' + p.description + '</div>' : '') +
                        '<div class="card-price">' + p.price + ' ‚ÇΩ</div>' +
                        '<button class="btn-add" onclick="addToCart(' + p.id + ')">–í –∫–æ—Ä–∑–∏–Ω—É</button>' +
                    '</div>' +
                '</div>'
            ).join('');
        }

        function selectCategory(id) {
            activeCategory = id;
            renderTabs();
            renderProducts();
        }

        function addToCart(id) {
            const product = products.find(p => p.id === id);
            const existing = cart.find(c => c.id === id);
            if (existing) {
                existing.qty++;
            } else {
                cart.push(Object.assign({}, product, { qty: 1 }));
            }
            updateCart();
            showNotification('‚úÖ ' + product.name + ' –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É');
            sendCartToBot();
        }

        function updateCart() {
            const count = cart.reduce(function(sum, c) { return sum + c.qty; }, 0);
            document.getElementById('cartCount').textContent = count;
        }

        function sendCartToBot() {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ—Ä–∑–∏–Ω—ã –≤ Telegram
            const cartData = cart.map(c => ({
                product_id: c.id,
                qty: c.qty,
                price: c.price
            }));
            
            fetch(API_BASE + '/api/cart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Telegram-Init-Data': tg.initData
                },
                body: JSON.stringify({
                    user_id: tg.initDataUnsafe?.user?.id || 0,
                    items: cartData
                })
            }).catch(err => console.error('Cart sync error:', err));
        }

        function openCart() {
            const modal = document.getElementById('cartModal');
            const items = document.getElementById('cartItems');
            const total = document.getElementById('cartTotal');
            
            if (cart.length === 0) {
                items.innerHTML = '<div class="empty-cart">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞<br>–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –º–µ–Ω—é</div>';
                total.textContent = '0';
            } else {
                items.innerHTML = cart.map(function(c) {
                    return '<div class="cart-item">' +
                        '<div><strong>' + c.name + '</strong> √ó ' + c.qty + '</div>' +
                        '<div style="font-weight: 600;">' + (c.price * c.qty) + ' ‚ÇΩ</div>' +
                    '</div>';
                }).join('');
                const totalPrice = cart.reduce(function(sum, c) { return sum + c.price * c.qty; }, 0);
                total.textContent = totalPrice;
            }
            
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeCart() {
            document.getElementById('cartModal').classList.remove('show');
            document.body.style.overflow = '';
        }

        function closeCartOnOutside(event) {
            if (event.target.id === 'cartModal') {
                closeCart();
            }
        }

        async function checkout() {
            console.log('[CHECKOUT] Starting checkout, cart:', cart);
            
            if (cart.length === 0) {
                tg.showAlert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞!');
                return;
            }
            
            const total = cart.reduce(function(sum, c) { return sum + c.price * c.qty; }, 0);
            const items = cart.map(c => ({
                product_id: c.id,
                name: c.name,
                qty: c.qty,
                price: c.price
            }));
            
            console.log('[CHECKOUT] Total:', total, 'Items:', items);
            
            try {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ—Ä–∑–∏–Ω—É –Ω–∞ backend
                const userId = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : 0;
                console.log('[CHECKOUT] User ID:', userId);
                
                const response = await fetch(API_BASE + '/api/cart', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        items: items,
                        total: total
                    })
                });
                
                if (response.ok) {
                    console.log('[CHECKOUT] Cart saved successfully');
                    showNotification('‚úÖ –ö–æ—Ä–∑–∏–Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞! –í–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ —á–∞—Ç –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞');
                    
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º WebApp
                    setTimeout(function() {
                        tg.close();
                    }, 1500);
                } else {
                    throw new Error('Server error: ' + response.status);
                }
            } catch (error) {
                console.error('[CHECKOUT] Error:', error);
                tg.showAlert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ—Ä–∑–∏–Ω—ã: ' + error.message);
            }
            
            closeCart();
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #4CAF50; color: white; padding: 12px 24px; border-radius: 8px; z-index: 1000; font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.2);';
            document.body.appendChild(notification);
            setTimeout(function() { notification.remove(); }, 2000);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        loadData();
    </script>
</body>
</html>
